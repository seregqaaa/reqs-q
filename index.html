<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="description"
      content="reqs-q is a simple and lightweight JavaScript library to help you control the order of requests"
    />
    <meta
      name="keywords"
      content="JavsScript, library, npm, requests, queue, requests, queue, order, js"
    />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>reqs-q usage example</title>
    <style>
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      .header {
        width: 100%;
        height: 60px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
      }

      .link-items {
        height: 100%;
        display: flex;
        flex-flow: row-nowrap;
        justify-content: center;
        align-items: center;
        list-style-type: none;
      }

      .link-item {
        height: 100%;
      }

      .link-item:not(.link-item:last-child) {
        margin-right: 30px;
      }

      .link {
        width: 50px;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0.75;
        transition: opacity 0.2s ease-in-out;
      }

      .link:hover,
      .link:focus {
        opacity: 1;
      }

      .link > img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .wrapper {
        padding: 20px;
        display: flex;
        justify-content: flex-start;
        align-items: center;
        flex-flow: column nowrap;
      }

      h1 {
        margin-bottom: 20px;
      }

      textarea:not(textarea:last-child) {
        margin-bottom: 40px;
      }

      .controls {
        width: 100%;
        margin-top: 20px;
        margin-bottom: 30px;
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }

      .button {
        max-width: 200px;
        width: 100%;
        height: 45px;
        padding: 5px 15px;

        display: flex;
        justify-content: center;
        align-items: center;

        border: none;
        border-radius: 10px;

        background-color: rgba(76, 204, 255, 0.7);
        color: rgba(20, 20, 40, 0.8);
        box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);

        font-size: 16px;
        font-weight: 600;

        transition: all 0.2s ease-in-out;

        cursor: pointer;
      }

      .button:hover:not(.button:disabled),
      .button:focus:not(.button:disabled) {
        background-color: rgba(76, 204, 255, 0.9);
        color: rgba(20, 20, 40, 0.95);
        box-shadow: 0 5px 7px rgba(0, 0, 0, 0.15);
      }

      .button:disabled {
        background-color: darkred;
        color: white;
        opacity: 0.5;
        cursor: not-allowed;
        font-size: 16px;
      }

      #restart {
        background-color: burlywood;
      }

      #area,
      #input,
      #url {
        width: 100%;
        max-width: 1200px;
        height: 100%;
        padding: 25px;
        background-color: rgba(0, 0, 0, 0.05);
        color: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 16px;
        font-size: 20px;
        resize: vertical;
      }

      #area {
        min-height: 400px;
      }

      #input {
        min-height: 260px;
      }

      p {
        font-size: 20px;
      }

      #version-title {
        position: fixed;
        bottom: 10px;
        right: 15px;
        opacity: 0.5;
      }

      .button,
      #area,
      #input,
      #url,
      p,
      h1,
      h3 {
        font-family: JetBrains Mono, JetBrains Mono NL, consolas, Arial,
          sans-serif;
      }
    </style>
  </head>
  <body>
    <h3 id="version-title">v0.1.5</h3>

    <header class="header">
      <ul class="link-items">
        <li class="link-item">
          <a
            href="https://github.com/siga44/reqs-q"
            class="link"
            target="_blank"
          >
            <img src="assets/images/gh-logo.png" alt="github" />
          </a>
        </li>
        <li class="link-item">
          <a
            href="https://www.npmjs.com/package/reqs-q"
            class="link"
            target="_blank"
          >
            <img src="assets/images/npm-logo.png" alt="npm" />
          </a>
        </li>
      </ul>
    </header>

    <main class="wrapper">
      <h1>reqs-q usage example</h1>
      <p>URL</p>
      <textarea name="url" id="url"></textarea>
      <p>Endpoints</p>
      <textarea name="endpoints" id="input"></textarea>
      <div class="controls">
        <button id="req" class="button">Make requests</button>
        <button id="restart" class="button">Restart queue</button>
      </div>
      <p>Result</p>
      <textarea
        name="textarea"
        id="area"
        contenteditable="false"
        disabled
      ></textarea>
    </main>

    <script type="module">
      import {
        RequestModel,
        RequestsQueue,
        QueueLogger,
        QueueStoreManager,
        stores,
      } from './src/index.js';

      const apiManager = {
        sendRequest,
      };

      const requestsQueue = new RequestsQueue({
        logger: new QueueLogger({ saveLogs: false, showLogs: true }),
        storeManager: new QueueStoreManager({
          store: stores.localStorage,
          restoreObject: apiManager,
        }),
      });
      window.requestsQueue = requestsQueue;

      const mainEl = document.querySelector('.wrapper');
      const button = mainEl.querySelector('#req');
      const resultArea = mainEl.querySelector('#area');
      const endpointsArea = mainEl.querySelector('#input');
      const urlArea = mainEl.querySelector('#url');
      const restart = mainEl.querySelector('#restart');

      const baseEndpoints = [
        'posts',
        'comments',
        'albums',
        'photos',
        'todos',
        'users',
      ];
      const baseUrl = 'https://jsonplaceholder.typicode.com';
      urlArea.value = baseUrl;
      endpointsArea.value = JSON.stringify(baseEndpoints, null, 2);

      let isUrlInvalid = false;
      let isEndpointsInvalid = false;
      let isActiveRequest = false;

      setInterval(() => {
        const text = 'Restart queue';
        localStorage.getItem(QueueStoreManager.LOCAL_STORAGE_KEY)?.length > 4 &&
        !isActiveRequest
          ? enableButton(restart, text)
          : disableButton(restart, text);
      }, 128);

      restart.addEventListener('click', e => {
        if (e.target.disabled || isActiveRequest) return;
        requestsQueue.restart();
      });

      button.addEventListener('click', e => {
        if (e.target.disabled) return;
        resultArea.value = '';
        const query = '?_start=0&_limit=2';
        const endpoints = JSON.parse(endpointsArea.value) ?? baseEndpoints;
        const url = urlArea.value ?? baseUrl;
        for (const endpoint of endpoints) {
          sendRequest(url, endpoint, baseUrl, query);
        }
      });

      urlArea.addEventListener('input', e => {
        try {
          new URL(e.target.value);
          isUrlInvalid = false;
          enableButton(button, 'Make requests');
        } catch (e) {
          isUrlInvalid = true;
          disableButton(button, 'Invalid URL');
        }
      });

      endpointsArea.addEventListener('input', e => {
        try {
          JSON.parse(e.target.value);
          isEndpointsInvalid = false;
          enableButton(button, 'Make requests');
        } catch (e) {
          isEndpointsInvalid = true;
          disableButton(button, 'Not JSON');
        }
      });

      function sendRequest(url, endpoint, baseUrl, query) {
        const request = new RequestModel({
          callback: () =>
            fetch(`${url}/${endpoint}${baseUrl === url ? query : ''}`),
          retryAfter: 1000,
          retriesCount: 2,
          propsToStore: {
            actionPath: sendRequest.name,
            args: [...arguments],
          },
        });
        requestsQueue
          .request(request)
          .then(result => handleResult(result, endpoint));
      }

      async function handleResult(result, endpoint) {
        const json = result.response?.json
          ? await result.response.json()
          : result;

        const displayData = Array.isArray(json)
          ? json.map(element =>
              Object.entries(element)
                .filter(([, value]) => typeof value !== 'object')
                .reduce(
                  (obj, [key, val]) => ({
                    ...obj,
                    [key]:
                      typeof val === 'string' && val.length > 30
                        ? val.slice(0, 30)
                        : val,
                  }),
                  {},
                ),
            )
          : json;

        resultArea.value += `${endpoint} ${JSON.stringify(
          displayData,
          null,
          2,
        )}\n\n`;
        resultArea.scrollTo({ top: resultArea.scrollTop + 1000 });

        console.log(endpoint, json);
      }

      function disableButton(button, text) {
        button.setAttribute('disabled', true);
        button.setAttribute('title', text);
        button.textContent = text;
      }

      function enableButton(button, text) {
        if (isEndpointsInvalid || isUrlInvalid) return;
        button.removeAttribute('disabled');
        button.textContent = text;
      }
    </script>
  </body>
</html>
