var __defProp=Object.defineProperty,__defProps=Object.defineProperties;var __getOwnPropDescs=Object.getOwnPropertyDescriptors;var __getOwnPropSymbols=Object.getOwnPropertySymbols;var __hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable;var __pow=Math.pow,__defNormalProp=(obj,key,value)=>key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value}):obj[key]=value,__spreadValues=(a,b)=>{for(var prop in b||(b={}))__hasOwnProp.call(b,prop)&&__defNormalProp(a,prop,b[prop]);if(__getOwnPropSymbols)for(var prop of __getOwnPropSymbols(b))__propIsEnum.call(b,prop)&&__defNormalProp(a,prop,b[prop]);return a},__spreadProps=(a,b)=>__defProps(a,__getOwnPropDescs(b)),__name=(target,value)=>__defProp(target,"name",{value,configurable:!0});var __accessCheck=(obj,member,msg)=>{if(!member.has(obj))throw TypeError("Cannot "+msg)};var __privateGet=(obj,member,getter)=>(__accessCheck(obj,member,"read from private field"),getter?getter.call(obj):member.get(obj)),__privateAdd=(obj,member,value)=>{if(member.has(obj))throw TypeError("Cannot add the same private member more than once");member instanceof WeakSet?member.add(obj):member.set(obj,value)},__privateSet=(obj,member,value,setter)=>(__accessCheck(obj,member,"write to private field"),setter?setter.call(obj,value):member.set(obj,value),value);var __privateMethod=(obj,member,method)=>(__accessCheck(obj,member,"access private method"),method);var __async=(__this,__arguments,generator)=>new Promise((resolve,reject)=>{var fulfilled=value=>{try{step(generator.next(value))}catch(e){reject(e)}},rejected=value=>{try{step(generator.throw(value))}catch(e){reject(e)}},step=x=>x.done?resolve(x.value):Promise.resolve(x.value).then(fulfilled,rejected);step((generator=generator.apply(__this,__arguments)).next())});var Priorities=(Priorities2=>(Priorities2[Priorities2.Low=1]="Low",Priorities2[Priorities2.Medium=2]="Medium",Priorities2[Priorities2.High=3]="High",Priorities2[Priorities2.Critical=4]="Critical",Priorities2))(Priorities||{});var ERR_TIMEOUT="ERR_TIMEOUT",ERR_UNKNOWN_NETWORK_ERROR="ERR_UNKNOWN_NETWORK_ERROR";function unlink(data){return JSON.parse(JSON.stringify(data))}__name(unlink,"unlink");function getDeepField(currentObj,rawPath){let path=[];if(path.push(...typeof rawPath=="string"?rawPath.split("."):rawPath),path.length===0||typeof currentObj!="object")return currentObj;let currentField=path[0];return path.shift(),getDeepField(currentObj[currentField],path)}__name(getDeepField,"getDeepField");function protectObject(object,allowedPropNames=["length"],error=new Error("This object is read-only")){return new Proxy(object,{get:(target,propName)=>{if(allowedPropNames.includes(propName))return target[propName];throw error},set:()=>{throw error}})}__name(protectObject,"protectObject");function getRandomFloat(max=__pow(2,48)){return Math.random()*max}__name(getRandomFloat,"getRandomFloat");function getRandomInt(max=__pow(2,48)){return Math.ceil(getRandomFloat(max))}__name(getRandomInt,"getRandomInt");function getRandomString(length=16,prevString=""){let string=getRandomInt().toString(16)+prevString;return string.length<length?getRandomString(length,string):string.substring(0,length)}__name(getRandomString,"getRandomString");var RequestModel=class{constructor(params={callback:()=>Promise.resolve()}){var _a,_b,_c,_d,_e,_f,_g,_h,_i;if(!params.callback)throw new Error('Required parameter "callback" was not provided');this.done=null,this.timestamps=new Timestamps(params.timestamps),this.timestamps.createdAt=Date.now(),this.callback=params.callback,this.errors=(_a=params.errors)!=null?_a:[],this.timeout=(_b=params.timeout)!=null?_b:15e3,this.response=(_c=params.response)!=null?_c:null,this.id=(_d=params.id)!=null?_d:getRandomString(),this.retryAfter=(_e=params.retryAfter)!=null?_e:null,this.retriesCount=(_f=params.retriesCount)!=null?_f:null,this.storeData=(_g=params.storeData)!=null?_g:{},this.priority=(_h=params.priority)!=null?_h:1,this.status=(_i=params.status)!=null?_i:"WAITING",this.storeData.storageDuration=this.storeData.storageDuration?this.storeData.storageDuration:1e3*60*60}};__name(RequestModel,"RequestModel");var Timestamps=class{constructor(props){var _a,_b,_c;this.createdAt=(_a=props==null?void 0:props.createdAt)!=null?_a:null,this.startedAt=(_b=props==null?void 0:props.startedAt)!=null?_b:null,this.doneAt=(_c=props==null?void 0:props.doneAt)!=null?_c:null}};__name(Timestamps,"Timestamps");var notRequestInstanceError=new Error("Expected to get instance of Request");var _queue,_isQueueBusy,_showErrors,_handleQueue,handleQueue_fn,_handleRequest,handleRequest_fn,_getResponse,getResponse_fn,_makeRequest,makeRequest_fn,_throwTimeout,throwTimeout_fn,RequestsQueueCore=class{constructor(params){__privateAdd(this,_handleQueue);__privateAdd(this,_handleRequest);__privateAdd(this,_getResponse);__privateAdd(this,_makeRequest);__privateAdd(this,_throwTimeout);__privateAdd(this,_queue,void 0);__privateAdd(this,_isQueueBusy,void 0);__privateAdd(this,_showErrors,void 0);var _a;__privateSet(this,_queue,[]),__privateSet(this,_isQueueBusy,!1),__privateSet(this,_showErrors,(_a=params.showErrors)!=null?_a:!0)}get _queue(){return __privateGet(this,_queue)}get queue(){return protectObject(__privateGet(this,_queue))}request(rawRequest){let request=typeof rawRequest=="function"?new RequestModel({callback:rawRequest}):rawRequest;if(!(request instanceof RequestModel))throw notRequestInstanceError;let promise=new Promise(r=>{request.done=r});return __privateGet(this,_queue).push(request),this.onRequestAdd(request),__privateGet(this,_isQueueBusy)||__privateMethod(this,_handleQueue,handleQueue_fn).call(this),promise}onRequestAdd(request){}beforeRequestHandle(){}onRequestStartExecute(request){}onRequestProgress(request,retriesDone){}onRetry(request,retriesDone){}onRequestFail(request){}onRequestSuccess(request){}onRequestDone(request){}afterRequestHandle(){}onQueueEmpty(){}};__name(RequestsQueueCore,"RequestsQueueCore"),_queue=new WeakMap,_isQueueBusy=new WeakMap,_showErrors=new WeakMap,_handleQueue=new WeakSet,handleQueue_fn=__name(function(){return __async(this,null,function*(){let queue=__privateGet(this,_queue);if(queue.length===0){__privateSet(this,_isQueueBusy,!1),this.onQueueEmpty();return}return __privateSet(this,_isQueueBusy,!0),queue.sort((a,b)=>b.priority-a.priority),this.beforeRequestHandle(),yield __privateMethod(this,_handleRequest,handleRequest_fn).call(this,queue[0]),queue.shift(),this.afterRequestHandle(),__privateMethod(this,_handleQueue,handleQueue_fn).call(this)})},"#handleQueue"),_handleRequest=new WeakSet,handleRequest_fn=__name(function(request){return __async(this,null,function*(){request.timestamps.startedAt=Date.now(),request.status="IN_PROGRESS",this.onRequestStartExecute(request);let response=yield __privateMethod(this,_getResponse,getResponse_fn).call(this,request);request.timestamps.doneAt=Date.now(),request.status="DONE",request.response=response,request.done&&request.done(request),this.onRequestDone(request)})},"#handleRequest"),_getResponse=new WeakSet,getResponse_fn=__name(function(request,retriesDone=0){return __async(this,null,function*(){let{retryAfter,retriesCount}=request,shouldRetryByConfig=retryAfter!==null&&retriesCount!==null,retryAfterTimeout=shouldRetryByConfig?retriesDone*retryAfter:0,response=yield new Promise(resolve=>setTimeout(()=>__async(this,null,function*(){return resolve(yield __privateMethod(this,_makeRequest,makeRequest_fn).call(this,request,retriesDone))}),retryAfterTimeout)),shouldRetry=shouldRetryByConfig&&response.isError&&retriesDone<retriesCount;return shouldRetry?this.onRetry(request,retriesDone):response.isError?this.onRequestFail(request):this.onRequestSuccess(request),shouldRetry?yield __privateMethod(this,_getResponse,getResponse_fn).call(this,request,retriesDone+1):response})},"#getResponse"),_makeRequest=new WeakSet,makeRequest_fn=__name(function(request,retriesDone=0){return __async(this,null,function*(){this.onRequestProgress(request,retriesDone);try{let result=yield Promise.race([request.callback(),__privateMethod(this,_throwTimeout,throwTimeout_fn).call(this,request.timeout)]);if(!result||result===ERR_TIMEOUT||result.status&&!(result.status>=200&&result.status<=299))throw new Error((result instanceof Response?result.statusText||result.status:result)||ERR_UNKNOWN_NETWORK_ERROR);return result}catch(e){__privateGet(this,_showErrors)&&console.error(e);let error={retriesDone,isError:!0,details:e,timestamp:Date.now()};return request.errors.push(error),error}})},"#makeRequest"),_throwTimeout=new WeakSet,throwTimeout_fn=__name(function(timeout){return new Promise((_,r)=>setTimeout(()=>r(ERR_TIMEOUT),timeout))},"#throwTimeout");var _logger,_storeManager,RequestsQueue=class extends RequestsQueueCore{constructor(params={}){var _a,_b,_c;super({showErrors:(_a=params.showErrors)!=null?_a:!0});__privateAdd(this,_logger,void 0);__privateAdd(this,_storeManager,void 0);__privateSet(this,_logger,(_b=params.logger)!=null?_b:null),__privateSet(this,_storeManager,(_c=params.storeManager)!=null?_c:null)}get logs(){if(!__privateGet(this,_logger))throw new Error("Logger was not provided when the instance was created");return protectObject(__privateGet(this,_logger).logs)}onRequestAdd(request){this.save(this._queue),this.log("Request has been added to the queue",request)}afterRequestHandle(){let queue=this._queue;queue.length>0&&this.log(`${queue.length} request${queue.length===1?"":"s"} left in the queue`,queue),this.save(queue)}onQueueEmpty(){this.log("Queue is empty, waiting for new requests...")}beforeRequestHandle(){this.log("Queue has been sorted by request priority",this._queue)}onRequestStartExecute(request){this.log("New request starts executing",request)}onRequestDone(request){this.log("Request result:",request)}onRetry(request,retriesDone){this.log(`Retrying: attempt ${retriesDone}`,request)}onRequestFail(request){this.log("Request has been failed",request)}onRequestSuccess(request){this.log("Request has been completed",request)}onRequestProgress(request,retriesDone){this.log(`Request in progress: attempt ${retriesDone}`,request)}log(...data){!__privateGet(this,_logger)||__privateGet(this,_logger).log(...data)}save(queue){!__privateGet(this,_storeManager)||__privateGet(this,_storeManager).save(unlink(queue))}load(){if(!!__privateGet(this,_storeManager))return __privateGet(this,_storeManager).load()}restart(){return __async(this,null,function*(){if(!!__privateGet(this,_storeManager))return yield __privateGet(this,_storeManager).restart()})}};__name(RequestsQueue,"RequestsQueue"),_logger=new WeakMap,_storeManager=new WeakMap;var _logs,_logLimit,_saveLogs,_showLogs,QueueLogger=class{constructor(params={}){__privateAdd(this,_logs,void 0);__privateAdd(this,_logLimit,void 0);__privateAdd(this,_saveLogs,void 0);__privateAdd(this,_showLogs,void 0);var _a,_b,_c;__privateSet(this,_logs,[]),__privateSet(this,_logLimit,(_a=params.logLimit)!=null?_a:50),__privateSet(this,_saveLogs,(_b=params.saveLogs)!=null?_b:!1),__privateSet(this,_showLogs,(_c=params.showLogs)!=null?_c:!0)}get logs(){return __privateGet(this,_logs)}log(...data){let unlinkedData=unlink(data),timestamp=Date.now();if(__privateGet(this,_showLogs)&&console.log(...unlinkedData,timestamp),!__privateGet(this,_saveLogs))return;let logObj=Object.entries(unlinkedData).reduce((logObj2,[key,val])=>__spreadProps(__spreadValues({},logObj2),{[key]:val}),{timestamp});__privateGet(this,_logs).length===__privateGet(this,_logLimit)&&__privateGet(this,_logs).pop(),__privateGet(this,_logs).unshift(logObj)}};__name(QueueLogger,"QueueLogger"),_logs=new WeakMap,_logLimit=new WeakMap,_saveLogs=new WeakMap,_showLogs=new WeakMap;function encodeb64(str){return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g,(_,p1)=>String.fromCharCode("0x"+p1)))}__name(encodeb64,"encodeb64");function decodeb64(str){return decodeURIComponent(atob(str).split("").map(c=>"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)).join(""))}__name(decodeb64,"decodeb64");var Stores=(Stores2=>(Stores2.LocalStorage="localStorage",Stores2))(Stores||{}),_store,_restoreObject,_showWarn,_shouldEncode,_saveToLocalStorage,saveToLocalStorage_fn,_loadFromLocalStorage,loadFromLocalStorage_fn,_prepareForStore,prepareForStore_fn,_checkArgsSafety,checkArgsSafety_fn,_QueueStoreManager=class{constructor(params={}){__privateAdd(this,_saveToLocalStorage);__privateAdd(this,_loadFromLocalStorage);__privateAdd(this,_prepareForStore);__privateAdd(this,_checkArgsSafety);__privateAdd(this,_store,void 0);__privateAdd(this,_restoreObject,void 0);__privateAdd(this,_showWarn,void 0);__privateAdd(this,_shouldEncode,void 0);var _a,_b,_c,_d;__privateSet(this,_store,(_a=params.store)!=null?_a:"localStorage"),__privateSet(this,_restoreObject,(_b=params.restoreObject)!=null?_b:null),__privateSet(this,_showWarn,(_c=params.showWarn)!=null?_c:!0),__privateSet(this,_shouldEncode,(_d=params.shouldEncode)!=null?_d:!0)}save(queue){switch(__privateGet(this,_store)){case"localStorage":__privateMethod(this,_saveToLocalStorage,saveToLocalStorage_fn).call(this,queue);break;default:return null}}load(){switch(__privateGet(this,_store)){case"localStorage":return __privateMethod(this,_loadFromLocalStorage,loadFromLocalStorage_fn).call(this);default:return null}}restart(){return __async(this,null,function*(){let restoreObject=__privateGet(this,_restoreObject);if(!restoreObject)return;let actions=this.load();if(!actions)return;let promises=actions.map(_0=>__async(this,[_0],function*({actionPath,args}){let field=getDeepField(restoreObject,actionPath),isFn=typeof field=="function";return isFn||console.error("Incorrect field type",{actionPath,args,field}),isFn?yield field(...args):field})),results=yield Promise.all(promises);return this.save([]),results})}},QueueStoreManager=_QueueStoreManager;__name(QueueStoreManager,"QueueStoreManager"),_store=new WeakMap,_restoreObject=new WeakMap,_showWarn=new WeakMap,_shouldEncode=new WeakMap,_saveToLocalStorage=new WeakSet,saveToLocalStorage_fn=__name(function(rawQueue){let queue=__privateMethod(this,_prepareForStore,prepareForStore_fn).call(this,rawQueue);localStorage.setItem(_QueueStoreManager.LOCAL_STORAGE_KEY,queue)},"#saveToLocalStorage"),_loadFromLocalStorage=new WeakSet,loadFromLocalStorage_fn=__name(function(){var _a;let localStorageQueue=((_a=localStorage.getItem(_QueueStoreManager.LOCAL_STORAGE_KEY))!=null?_a:__privateGet(this,_shouldEncode))?encodeb64("[]"):"[]",decodedQueue=__privateGet(this,_shouldEncode)?decodeb64(localStorageQueue):localStorageQueue;return JSON.parse(decodedQueue).filter(item=>item.timestamp+item.storageDuration>=Date.now()).map(item=>({actionPath:item.actionPath,args:__privateMethod(this,_checkArgsSafety,checkArgsSafety_fn).call(this,item.args)}))},"#loadFromLocalStorage"),_prepareForStore=new WeakSet,prepareForStore_fn=__name(function(queue){let filteredQueue=queue.map(r=>{var _a;return __spreadProps(__spreadValues({},r.storeData),{args:__privateMethod(this,_checkArgsSafety,checkArgsSafety_fn).call(this,(_a=r.storeData.args)!=null?_a:[]),timestamp:Date.now()})}).filter(item=>Boolean(item.actionPath)),stringifiedQueue=JSON.stringify(filteredQueue);return __privateGet(this,_shouldEncode)?encodeb64(stringifiedQueue):stringifiedQueue},"#prepareForStore"),_checkArgsSafety=new WeakSet,checkArgsSafety_fn=__name(function(args){return __privateGet(this,_showWarn)?args.map(arg=>{try{new URL(arg),console.warn(`Saving argument "${arg}" may be not safe`)}catch(_){}finally{return arg}}):args},"#checkArgsSafety"),QueueStoreManager.LOCAL_STORAGE_KEY="__reqs-q-v1.2.0__";export{Priorities,QueueLogger,QueueStoreManager,RequestModel,RequestsQueue,RequestsQueueCore,Stores};
